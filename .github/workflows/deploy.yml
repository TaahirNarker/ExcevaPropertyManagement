name: ğŸš€ Auto Deploy to Production

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 22
        script: |
          echo "ğŸš€ Auto-deploy triggered by GitHub push"
          echo "ğŸ“… Deployment time: $(date)"
          echo "ğŸ”— Repository: ${{ github.repository }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          
          # Set error handling
          set -e
          
          # Navigate to project directory
          echo "ğŸ“ Navigating to project directory..."
          cd /var/www/ExcevaPropertyManagement
          
          # Check if directory exists
          if [ ! -d "/var/www/ExcevaPropertyManagement" ]; then
            echo "âŒ Project directory not found. Creating it..."
            sudo mkdir -p /var/www/ExcevaPropertyManagement
            sudo chown ubuntu:ubuntu /var/www/ExcevaPropertyManagement
          fi
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes from GitHub..."
          git pull origin main || {
            echo "âŒ Failed to pull changes. Cloning repository..."
            git clone https://github.com/TaahirNarker/ExcevaPropertyManagement.git .
          }
          
          # Check if virtual environment exists
          if [ ! -d "backend/venv" ]; then
            echo "ğŸ Creating virtual environment..."
            cd backend
            python3 -m venv venv
            cd ..
          fi
          
          # Activate virtual environment
          echo "ğŸ”§ Activating virtual environment..."
          source backend/venv/bin/activate
          
          # Install/update dependencies
          echo "ğŸ“¦ Installing/updating dependencies..."
          pip install -r backend/requirements.txt
          
          # Run database migrations
          echo "ğŸ—„ï¸ Running database migrations..."
          python backend/manage.py migrate
          
          # Collect static files
          echo "ğŸ“ Collecting static files..."
          python backend/manage.py collectstatic --noinput
          
          # Restart services
          echo "ğŸ”„ Restarting services..."
          pm2 restart all || {
            echo "âš ï¸ PM2 restart failed. Starting services..."
            pm2 start backend/start_production.sh --name "exceva-backend"
            pm2 start "npm run start" --name "exceva-frontend" --cwd frontend
          }
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Live site: https://propman.exceva.capital"
          
    - name: âœ… Deployment Status
      if: always()
      run: |
        echo "ğŸš€ Deployment Status: ${{ job.status }}"
        echo "ğŸ“… Completed at: $(date)"
        echo "ğŸ”— Repository: ${{ github.repository }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Live site: https://propman.exceva.capital"
        else
          echo "âŒ Deployment failed. Check the logs above for details."
        fi
